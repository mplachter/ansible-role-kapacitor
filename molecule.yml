---
driver:
  name: vagrant
vagrant:
  platforms:
    - name: xenial64
      box: bento/ubuntu-16.04
  providers:
    - name: virtualbox
      type: virtualbox
  instances:
    - name: vagrant-01
      raw_config_args:
        - "vm.synced_folder '${MOLECULE_APT_CONF_D_PATH}', '/etc/apt/apt.conf.d'"

verifier:
  name: testinfra

ansible:
  playbook: tests/playbook.yml
  group_vars:
    all:
      kapacitor_stream_thresholds:
        - name: load_average
          measurement: system
          field: load1
          groupBy: host
          period: 3m
          every: 1m
          warn: "> 4"
          crit: "> 8"
      
        - name: usage_user_short
          measurement: cpu
          field: usage_user
          groupBy: host
          period: 5m
          every: 1m
          warn: "> 60"
          crit: "> 75"

      kapacitor_stream_thresholds_disable:
        - usage_user_short

      kapacitor_message: '{{"{{"}} if eq .Level "OK" }}OK{{"{{"}} else }}{{"{{"}} .Level }}{{"{{"}} end }}: {{"{{"}} .ID }}: {{item.field}} {{"{{"}} index .Fields "field_mean" | printf "%0.1f" }} for {{item.period}}, at {{"{{"}} .Time }}'
      kapacitor_details: "{{ kapacitor_message }}"
      
      kapacitor_warn_alerts:
        - stateChangesOnly()
        - log('/var/log/kapacitor/alerts.log')
      
      kapacitor_crit_alerts:
        - stateChangesOnly(10m)
        - email()
        - log('/var/log/kapacitor/alerts.log')

      kapacitor_stream_database: kapacitor
